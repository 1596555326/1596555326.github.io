<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线投票系统</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .nav {
            display: flex;
            background: #34495e;
            flex-wrap: wrap;
        }
        
        .nav button {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .nav button:hover {
            background: #3a506b;
        }
        
        .nav button.active {
            background: #1abc9c;
        }
        
        .content {
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .vote-option {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .vote-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .vote-item input[type="radio"],
        .vote-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .qrcode-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .progress-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s;
        }
        
        .vote-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .vote-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .vote-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .settings-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .deploy-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .vote-type-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .vote-type-option {
            display: flex;
            align-items: center;
        }
        
        .vote-type-option input[type="radio"] {
            width: auto;
            margin-right: 8px;
        }
        
        .option-description {
            margin-top: 10px;
        }
        
        .option-description textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .user-vote-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .user-vote-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .user-vote-options {
            margin: 20px 0;
        }
        
        .user-vote-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .user-vote-option:hover {
            background: #f8f9fa;
        }
        
        .user-vote-option input[type="radio"],
        .user-vote-option input[type="checkbox"] {
            margin-right: 15px;
        }
        
        .user-vote-option label {
            flex: 1;
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        .user-vote-option .option-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .vote-type-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .user-vote-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>在线投票系统</h1>
            <p>创建、发布和管理您的投票活动</p>
        </div>
        
        <div class="nav">
            <button onclick="showTab('manage')" class="active">投票管理</button>
            <button onclick="showTab('create')">创建投票</button>
            <button onclick="showTab('results')">投票结果</button>
            <button onclick="showTab('vote')">参与投票</button>
            <button onclick="showTab('deploy')">部署指南</button>
        </div>
        
        <div class="content">
            <!-- 投票管理 -->
            <div id="manage" class="tab-content active">
                <h2>投票管理</h2>
                <div class="vote-list" id="voteList">
                    <!-- 投票列表将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 创建投票 -->
            <div id="create" class="tab-content">
                <h2>创建新投票</h2>
                <form id="voteForm">
                    <div class="form-group">
                        <label for="voteTitle">投票标题</label>
                        <input type="text" id="voteTitle" placeholder="请输入投票标题" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="voteDescription">投票描述</label>
                        <textarea id="voteDescription" placeholder="请输入投票描述" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>投票类型</label>
                        <div class="vote-type-container">
                            <div class="vote-type-option">
                                <input type="radio" id="single" name="voteType" value="single" checked>
                                <label for="single">单选</label>
                            </div>
                            <div class="vote-type-option">
                                <input type="radio" id="multiple" name="voteType" value="multiple">
                                <label for="multiple">多选</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>投票选项</label>
                        <div id="voteOptions">
                            <div class="vote-option">
                                <input type="text" placeholder="选项1" class="option-input" required>
                                <div class="option-description">
                                    <label>选项描述（可选）</label>
                                    <textarea placeholder="请输入选项描述" class="option-desc"></textarea>
                                </div>
                                <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="margin-top: 10px; padding: 5px 10px;">删除</button>
                            </div>
                            <div class="vote-option">
                                <input type="text" placeholder="选项2" class="option-input" required>
                                <div class="option-description">
                                    <label>选项描述（可选）</label>
                                    <textarea placeholder="请输入选项描述" class="option-desc"></textarea>
                                </div>
                                <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="margin-top: 10px; padding: 5px 10px;">删除</button>
                            </div>
                        </div>
                        <button type="button" class="btn" onclick="addOption()">添加选项</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="startTime">开始时间</label>
                        <input type="datetime-local" id="startTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endTime">结束时间</label>
                        <input type="datetime-local" id="endTime" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="collectInfo">收集投票人信息</label>
                        <select id="collectInfo">
                            <option value="none">不收集</option>
                            <option value="name">仅姓名</option>
                            <option value="contact">仅联系方式</option>
                            <option value="both">姓名和联系方式</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">创建投票</button>
                </form>
            </div>
            
            <!-- 投票结果 -->
            <div id="results" class="tab-content">
                <h2>投票结果</h2>
                <div id="resultContent">
                    <p>请从"投票管理"中选择一个投票活动查看结果</p>
                </div>
            </div>
            
            <!-- 参与投票 -->
            <div id="vote" class="tab-content">
                <h2>参与投票</h2>
                <div class="settings-panel">
                    <h3>服务器配置</h3>
                    <p>为了让微信能够正常扫码访问，您需要将系统部署到服务器上。</p>
                    <div class="form-group">
                        <label for="serverUrl">服务器地址 (URL)</label>
                        <input type="text" id="serverUrl" placeholder="例如: https://www.yourdomain.com/vote.html">
                        <small>请填写您部署投票系统的完整URL地址</small>
                    </div>
                    <button class="btn" onclick="saveServerUrl()">保存服务器地址</button>
                </div>
                <div id="voteContent">
                    <p>请先设置服务器地址，然后选择投票活动生成二维码</p>
                </div>
            </div>
            
            <!-- 部署指南 -->
            <div id="deploy" class="tab-content">
                <h2>部署指南</h2>
                <div class="deploy-notice">
                    <h3>重要提示</h3>
                    <p>当前系统在本地运行时，生成的二维码链接是本地文件路径(<code>file:///...</code>)，这种链接无法在微信中正常访问。</p>
                    <p>要让微信能够扫码访问，您需要将系统部署到Web服务器上。</p>
                </div>
                
                <h3>部署步骤</h3>
                <ol>
                    <li>将本HTML文件上传到您的Web服务器</li>
                    <li>确保可以通过公网URL访问这个文件（如：https://www.yourdomain.com/vote.html）</li>
                    <li>在"参与投票"页面设置服务器地址</li>
                    <li>现在生成的二维码就可以在微信中正常扫描和访问了</li>
                </ol>
                
                <h3>推荐的部署方式</h3>
                <div class="stats">
                    <div class="stat-card">
                        <h4>GitHub Pages (免费)</h4>
                        <p>将代码上传到GitHub仓库，启用GitHub Pages功能</p>
                        <button class="btn" onclick="window.open('https://pages.github.com/', '_blank')">了解详情</button>
                    </div>
                    <div class="stat-card">
                        <h4>Netlify (免费)</h4>
                        <p>直接拖拽HTML文件到Netlify进行部署</p>
                        <button class="btn" onclick="window.open('https://www.netlify.com/', '_blank')">了解详情</button>
                    </div>
                    <div class="stat-card">
                        <h4>传统虚拟主机</h4>
                        <p>通过FTP将文件上传到您的虚拟主机</p>
                    </div>
                </div>
                
                <h3>测试部署是否成功</h3>
                <p>部署完成后，请用手机浏览器访问您的URL，确保页面正常显示。</p>
            </div>
        </div>
    </div>

    <script>
        // 存储投票数据
        let votes = JSON.parse(localStorage.getItem('votes')) || {};
        let currentVoteId = null;
        let serverUrl = localStorage.getItem('voteSystemServerUrl') || '';
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认时间
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startTime').value = formatDateTime(now);
            document.getElementById('endTime').value = formatDateTime(tomorrow);
            
            // 加载服务器URL
            if (serverUrl) {
                document.getElementById('serverUrl').value = serverUrl;
            }
            
            // 加载投票列表
            loadVoteList();
            
            // 表单提交事件
            document.getElementById('voteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createVote();
            });
            
            // 检查URL参数，显示对应的投票页面
            const urlParams = new URLSearchParams(window.location.search);
            const voteParam = urlParams.get('vote');
            if (voteParam && votes[voteParam]) {
                showUserVotePage(voteParam);
            }
        });
        
        // 显示标签页
        function showTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按钮的active类
            document.querySelectorAll('.nav button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            
            // 为当前按钮添加active类
            event.target.classList.add('active');
            
            // 如果是投票管理标签，刷新列表
            if (tabName === 'manage') {
                loadVoteList();
            }
        }
        
        // 保存服务器URL
        function saveServerUrl() {
            serverUrl = document.getElementById('serverUrl').value.trim();
            if (serverUrl && !serverUrl.startsWith('http')) {
                alert('服务器地址应以 http:// 或 https:// 开头');
                return;
            }
            
            localStorage.setItem('voteSystemServerUrl', serverUrl);
            alert('服务器地址已保存');
        }
        
        // 添加投票选项
        function addOption() {
            const optionsContainer = document.getElementById('voteOptions');
            const optionCount = optionsContainer.children.length;
            const newOption = document.createElement('div');
            newOption.className = 'vote-option';
            newOption.innerHTML = `
                <input type="text" placeholder="选项${optionCount + 1}" class="option-input" required>
                <div class="option-description">
                    <label>选项描述（可选）</label>
                    <textarea placeholder="请输入选项描述" class="option-desc"></textarea>
                </div>
                <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="margin-top: 10px; padding: 5px 10px;">删除</button>
            `;
            optionsContainer.appendChild(newOption);
        }
        
        // 删除投票选项
        function removeOption(button) {
            if (document.getElementById('voteOptions').children.length > 2) {
                button.parentElement.remove();
            } else {
                alert('至少需要两个投票选项');
            }
        }
        
        // 创建投票
        function createVote() {
            const title = document.getElementById('voteTitle').value;
            const description = document.getElementById('voteDescription').value;
            const voteType = document.querySelector('input[name="voteType"]:checked').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const collectInfo = document.getElementById('collectInfo').value;
            
            // 获取选项
            const options = [];
            const optionInputs = document.querySelectorAll('.vote-option');
            
            optionInputs.forEach(optionDiv => {
                const textInput = optionDiv.querySelector('.option-input');
                const descInput = optionDiv.querySelector('.option-desc');
                
                if (textInput.value.trim()) {
                    options.push({
                        text: textInput.value.trim(),
                        description: descInput.value.trim(),
                        votes: 0
                    });
                }
            });
            
            if (options.length < 2) {
                alert('请至少添加两个投票选项');
                return;
            }
            
            // 生成唯一ID
            const voteId = 'vote_' + Date.now();
            
            // 创建投票对象
            votes[voteId] = {
                id: voteId,
                title: title,
                description: description,
                type: voteType,
                options: options,
                startTime: startTime,
                endTime: endTime,
                collectInfo: collectInfo,
                status: 'active',
                created: new Date().toISOString(),
                totalVotes: 0,
                voters: []
            };
            
            // 保存到本地存储
            localStorage.setItem('votes', JSON.stringify(votes));
            
            // 重置表单
            document.getElementById('voteForm').reset();
            
            // 重置选项
            const optionsContainer = document.getElementById('voteOptions');
            optionsContainer.innerHTML = '';
            optionsContainer.innerHTML = `
                <div class="vote-option">
                    <input type="text" placeholder="选项1" class="option-input" required>
                    <div class="option-description">
                        <label>选项描述（可选）</label>
                        <textarea placeholder="请输入选项描述" class="option-desc"></textarea>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="margin-top: 10px; padding: 5px 10px;">删除</button>
                </div>
                <div class="vote-option">
                    <input type="text" placeholder="选项2" class="option-input" required>
                    <div class="option-description">
                        <label>选项描述（可选）</label>
                        <textarea placeholder="请输入选项描述" class="option-desc"></textarea>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeOption(this)" style="margin-top: 10px; padding: 5px 10px;">删除</button>
                </div>
            `;
            
            // 设置默认时间
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('startTime').value = formatDateTime(now);
            document.getElementById('endTime').value = formatDateTime(tomorrow);
            
            alert('投票创建成功！');
            showTab('manage');
            loadVoteList();
        }
        
        // 加载投票列表
        function loadVoteList() {
            const voteList = document.getElementById('voteList');
            voteList.innerHTML = '';
            
            if (Object.keys(votes).length === 0) {
                voteList.innerHTML = '<p>暂无投票活动，请创建新投票</p>';
                return;
            }
            
            Object.values(votes).forEach(vote => {
                const voteCard = document.createElement('div');
                voteCard.className = 'vote-card';
                voteCard.innerHTML = `
                    <h3>${vote.title}</h3>
                    <p>${vote.description || '无描述'}</p>
                    <p><strong>类型:</strong> ${vote.type === 'single' ? '单选' : '多选'} | 
                    <strong>状态:</strong> ${getVoteStatus(vote)}</p>
                    <p><strong>时间:</strong> ${formatDisplayDate(vote.startTime)} 至 ${formatDisplayDate(vote.endTime)}</p>
                    <p><strong>总票数:</strong> ${vote.totalVotes}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="viewVote('${vote.id}')">查看详情</button>
                        <button class="btn" onclick="showQRCode('${vote.id}')">生成二维码</button>
                        <button class="btn" onclick="exportResults('${vote.id}')">导出结果</button>
                        <button class="btn btn-danger" onclick="deleteVote('${vote.id}')">删除</button>
                    </div>
                `;
                voteList.appendChild(voteCard);
            });
        }
        
        // 查看投票详情
        function viewVote(voteId) {
            const vote = votes[voteId];
            if (!vote) return;
            
            currentVoteId = voteId;
            
            // 显示结果标签
            showTab('results');
            
            // 生成结果页面
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <h3>${vote.title}</h3>
                <p>${vote.description || '无描述'}</p>
                
                <div class="stats">
                    <div class="stat-card">
                        <h4>总票数</h4>
                        <p style="font-size: 2em; color: #3498db;">${vote.totalVotes}</p>
                    </div>
                    <div class="stat-card">
                        <h4>投票状态</h4>
                        <p style="font-size: 1.5em; color: ${getVoteStatus(vote) === '进行中' ? '#27ae60' : '#e74c3c'};">${getVoteStatus(vote)}</p>
                    </div>
                    <div class="stat-card">
                        <h4>投票类型</h4>
                        <p style="font-size: 1.5em;">${vote.type === 'single' ? '单选' : '多选'}</p>
                    </div>
                </div>
                
                <h4>投票结果</h4>
                <div id="voteResults">
                    ${generateResultsHTML(vote)}
                </div>
                
                <button class="btn" onclick="exportResults('${voteId}')" style="margin-top: 20px;">导出CSV结果</button>
            `;
        }
        
        // 生成结果HTML
        function generateResultsHTML(vote) {
            let html = '';
            const maxVotes = Math.max(...vote.options.map(opt => opt.votes), 1);
            
            vote.options.forEach(option => {
                const percentage = vote.totalVotes > 0 ? (option.votes / vote.totalVotes * 100).toFixed(1) : 0;
                html += `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: between;">
                            <div>
                                <strong>${option.text}</strong>
                                ${option.description ? `<p style="margin: 5px 0; color: #666; font-size: 0.9em;">${option.description}</p>` : ''}
                            </div>
                            <span>${option.votes} 票 (${percentage}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // 显示二维码
        function showQRCode(voteId) {
            const vote = votes[voteId];
            if (!vote) return;
            
            // 检查是否设置了服务器URL
            if (!serverUrl) {
                alert('请先在"参与投票"页面设置服务器地址，以便生成可微信扫描的二维码');
                showTab('vote');
                return;
            }
            
            currentVoteId = voteId;
            
            // 显示投票标签
            showTab('vote');
            
            // 生成投票页面URL - 使用服务器地址
            const voteUrl = `${serverUrl}?vote=${voteId}`;
            
            const voteContent = document.getElementById('voteContent');
            voteContent.innerHTML = `
                <h3>${vote.title}</h3>
                <p>扫描以下二维码参与投票：</p>
                
                <div class="qrcode-container">
                    <div id="qrcode"></div>
                    <p>或直接访问：<a href="${voteUrl}" target="_blank">${voteUrl}</a></p>
                </div>
                
                <div class="form-group">
                    <label>投票链接</label>
                    <input type="text" value="${voteUrl}" readonly>
                    <button class="btn" onclick="copyToClipboard('${voteUrl}')">复制链接</button>
                </div>
                
                <div class="deploy-notice">
                    <h4>测试说明</h4>
                    <p>请确保您的系统已部署到服务器 (<strong>${serverUrl}</strong>)</p>
                    <p>使用微信扫描上面的二维码，测试投票功能是否正常工作。</p>
                </div>
            `;
            
            // 生成二维码
            const qrcodeContainer = document.getElementById('qrcode');
            qrcodeContainer.innerHTML = '';
            
            QRCode.toCanvas(qrcodeContainer, voteUrl, {
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            }, function(error) {
                if (error) {
                    console.error(error);
                    alert('生成二维码时出错: ' + error.message);
                }
            });
        }
        
        // 显示用户投票页面（独立的用户界面）
        function showUserVotePage(voteId) {
            const vote = votes[voteId];
            if (!vote) {
                document.body.innerHTML = '<div class="container"><div class="header"><h1>投票不存在或已结束</h1></div></div>';
                return;
            }
            
            // 检查投票状态
            const now = new Date();
            const startTime = new Date(vote.startTime);
            const endTime = new Date(vote.endTime);
            
            if (now < startTime) {
                document.body.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>投票尚未开始</h1>
                            <p>开始时间: ${formatDisplayDate(vote.startTime)}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (now > endTime) {
                document.body.innerHTML = `
                    <div class="container">
                        <div class="header">
                            <h1>投票已结束</h1>
                            <p>结束时间: ${formatDisplayDate(vote.endTime)}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // 生成用户投票页面
            document.body.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${vote.title}</h1>
                        <p>${vote.description || ''}</p>
                    </div>
                    <div class="user-vote-container">
                        <form id="userVoteForm">
                            <div class="user-vote-header">
                                <h2>请选择您的选项</h2>
                            </div>
                            
                            <div class="user-vote-options">
                                ${generateUserVoteOptionsHTML(vote)}
                            </div>
                            
                            ${vote.collectInfo !== 'none' ? `
                                <div class="form-group">
                                    <label for="voterName">${vote.collectInfo.includes('name') ? '姓名' : ''}</label>
                                    <input type="text" id="voterName" ${vote.collectInfo.includes('name') ? 'required' : ''}>
                                </div>
                            ` : ''}
                            
                            ${vote.collectInfo.includes('contact') ? `
                                <div class="form-group">
                                    <label for="voterContact">联系方式</label>
                                    <input type="text" id="voterContact" required>
                                </div>
                            ` : ''}
                            
                            <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 18px;">提交投票</button>
                        </form>
                    </div>
                </div>
            `;
            
            // 添加表单提交事件
            document.getElementById('userVoteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitUserVote(voteId);
            });
        }
        
        // 生成用户投票选项HTML
        function generateUserVoteOptionsHTML(vote) {
            let html = '';
            const inputType = vote.type === 'single' ? 'radio' : 'checkbox';
            const inputName = vote.type === 'single' ? 'voteOption' : 'voteOptions';
            
            vote.options.forEach((option, index) => {
                html += `
                    <div class="user-vote-option">
                        <input type="${inputType}" id="user-option-${index}" name="${inputName}" value="${index}">
                        <label for="user-option-${index}">
                            <strong>${option.text}</strong>
                            ${option.description ? `<div class="option-description">${option.description}</div>` : ''}
                        </label>
                    </div>
                `;
            });
            
            return html;
        }
        
        // 提交用户投票
        function submitUserVote(voteId) {
            const vote = votes[voteId];
            if (!vote) return;
            
            // 获取选择的选项
            let selectedOptions = [];
            if (vote.type === 'single') {
                const selected = document.querySelector('input[name="voteOption"]:checked');
                if (!selected) {
                    alert('请选择一个选项');
                    return;
                }
                selectedOptions.push(parseInt(selected.value));
            } else {
                const selected = document.querySelectorAll('input[name="voteOptions"]:checked');
                if (selected.length === 0) {
                    alert('请至少选择一个选项');
                    return;
                }
                selected.forEach(option => {
                    selectedOptions.push(parseInt(option.value));
                });
            }
            
            // 获取投票人信息
            const voterName = vote.collectInfo.includes('name') ? document.getElementById('voterName').value : '';
            const voterContact = vote.collectInfo.includes('contact') ? document.getElementById('voterContact').value : '';
            
            // 更新投票数据
            selectedOptions.forEach(optionIndex => {
                vote.options[optionIndex].votes++;
            });
            
            vote.totalVotes++;
            vote.voters.push({
                name: voterName,
                contact: voterContact,
                choices: selectedOptions.map(i => vote.options[i].text),
                timestamp: new Date().toISOString()
            });
            
            // 保存到本地存储
            localStorage.setItem('votes', JSON.stringify(votes));
            
            // 显示成功消息
            document.body.innerHTML = `
                <div class="container">
                    <div class="header">
                        <h1>${vote.title}</h1>
                    </div>
                    <div class="user-vote-container">
                        <div class="success-message">
                            <h3>投票成功！</h3>
                            <p>感谢您的参与。</p>
                        </div>
                        <button class="btn" onclick="window.location.href = '${serverUrl || window.location.href.split('?')[0]}'">返回首页</button>
                    </div>
                </div>
            `;
        }
        
        // 导出结果
        function exportResults(voteId) {
            const vote = votes[voteId];
            if (!vote) return;
            
            // 准备CSV数据
            let csvData = [];
            
            // 添加标题行
            csvData.push(['投票标题', vote.title]);
            csvData.push(['投票描述', vote.description || '']);
            csvData.push(['投票类型', vote.type === 'single' ? '单选' : '多选']);
            csvData.push(['开始时间', vote.startTime]);
            csvData.push(['结束时间', vote.endTime]);
            csvData.push(['总票数', vote.totalVotes]);
            csvData.push([]);
            
            // 添加选项结果
            csvData.push(['选项', '选项描述', '票数', '百分比']);
            vote.options.forEach(option => {
                const percentage = vote.totalVotes > 0 ? (option.votes / vote.totalVotes * 100).toFixed(2) : 0;
                csvData.push([option.text, option.description || '', option.votes, `${percentage}%`]);
            });
            
            csvData.push([]);
            
            // 添加投票人信息（如果有）
            if (vote.voters.length > 0) {
                csvData.push(['投票人信息']);
                const headers = [];
                if (vote.collectInfo.includes('name')) headers.push('姓名');
                if (vote.collectInfo.includes('contact')) headers.push('联系方式');
                headers.push('投票时间', '选择项');
                
                csvData.push(headers);
                
                vote.voters.forEach(voter => {
                    const row = [];
                    if (vote.collectInfo.includes('name')) row.push(voter.name || '');
                    if (vote.collectInfo.includes('contact')) row.push(voter.contact || '');
                    row.push(voter.timestamp, voter.choices.join(', '));
                    csvData.push(row);
                });
            }
            
            // 转换为CSV字符串
            const csv = Papa.unparse(csvData);
            
            // 创建下载链接
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `投票结果_${vote.title}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 删除投票
        function deleteVote(voteId) {
            if (confirm('确定要删除这个投票吗？此操作不可撤销。')) {
                delete votes[voteId];
                localStorage.setItem('votes', JSON.stringify(votes));
                loadVoteList();
            }
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('链接已复制到剪贴板');
            }, function(err) {
                console.error('复制失败: ', err);
                // 备用方案
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('链接已复制到剪贴板');
            });
        }
        
        // 工具函数：格式化日期时间为本地字符串
        function formatDateTime(date) {
            return date.toISOString().slice(0, 16);
        }
        
        // 工具函数：格式化显示日期
        function formatDisplayDate(dateString) {
            return new Date(dateString).toLocaleString('zh-CN');
        }
        
        // 工具函数：获取投票状态
        function getVoteStatus(vote) {
            const now = new Date();
            const start = new Date(vote.startTime);
            const end = new Date(vote.endTime);
            
            if (now < start) return '未开始';
            if (now > end) return '已结束';
            return '进行中';
        }
    </script>
</body>
</html>
