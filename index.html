<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可编辑投票系统</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .mode-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .mode-btn:hover {
            background: #2980b9;
        }
        
        .mode-btn.active {
            background: #e74c3c;
        }
        
        .admin-panel {
            display: none;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .user-panel {
            display: block;
        }
        
        .user-panel.active {
            display: block;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .admin-title {
            font-size: 2em;
            color: #2c3e50;
        }
        
        .admin-actions {
            display: flex;
            gap: 15px;
        }
        
        .admin-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background 0.3s;
        }
        
        .admin-btn:hover {
            background: #2980b9;
        }
        
        .admin-btn.save {
            background: #2ecc71;
        }
        
        .admin-btn.save:hover {
            background: #27ae60;
        }
        
        .admin-btn.export {
            background: #9b59b6;
        }
        
        .admin-btn.export:hover {
            background: #8e44ad;
        }
        
        .topics-container {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .topic-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
        }
        
        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .topic-title {
            font-size: 1.8em;
            color: #2c3e50;
            width: 70%;
            border: none;
            background: transparent;
            padding: 5px;
        }
        
        .topic-title:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px #3498db;
            border-radius: 5px;
        }
        
        .topic-actions {
            display: flex;
            gap: 10px;
        }
        
        .topic-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        
        .topic-btn.edit {
            background: #f39c12;
        }
        
        .topic-btn.edit:hover {
            background: #e67e22;
        }
        
        .topic-btn.delete {
            background: #e74c3c;
        }
        
        .topic-btn.delete:hover {
            background: #c0392b;
        }
        
        .topic-description {
            font-size: 1.3em;
            color: #7f8c8d;
            margin-bottom: 20px;
            line-height: 1.5;
            width: 100%;
            border: none;
            background: transparent;
            padding: 5px;
            resize: vertical;
            min-height: 60px;
        }
        
        .topic-description:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px #3498db;
            border-radius: 5px;
        }
        
        .options-container {
            display: grid;
            gap: 15px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .option-text {
            flex: 1;
            font-size: 1.3em;
            color: #2c3e50;
            border: none;
            background: transparent;
            padding: 5px;
        }
        
        .option-text:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px #3498db;
        }
        
        .option-actions {
            display: flex;
            gap: 10px;
        }
        
        .option-btn {
            background: #bdc3c7;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .option-btn.delete {
            background: #e74c3c;
        }
        
        .add-option {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-option input {
            flex: 1;
            padding: 10px;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            font-size: 1.1em;
        }
        
        .add-option button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }
        
        .tab {
            padding: 20px 30px;
            color: white;
            cursor: pointer;
            font-size: 1.3em;
            border-bottom: 4px solid transparent;
            white-space: nowrap;
            flex: 1;
            text-align: center;
            min-width: 200px;
        }
        
        .tab.active {
            background: #2c3e50;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .vote-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .vote-description {
            font-size: 1.3em;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .vote-options-container {
            display: grid;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .vote-option {
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .vote-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .vote-option.selected {
            border-color: #2ecc71;
            background: #d5f4e6;
        }
        
        .option-text-display {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .submit-section {
            margin-top: 40px;
            border-top: 2px solid #ecf0f1;
            padding-top: 30px;
        }
        
        .submit-btn {
            width: 100%;
            background: #2ecc71;
            color: white;
            border: none;
            padding: 25px;
            font-size: 1.8em;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .submit-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: none;
            padding: 40px;
        }
        
        .result-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .result-item {
            margin-bottom: 25px;
        }
        
        .result-label {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #ecf0f1;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 20px;
            transition: width 0.5s ease;
            min-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .thank-you {
            text-align: center;
            font-size: 1.8em;
            color: #2c3e50;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .qr-section {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-top: 3px solid #e9ecef;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .qr-code img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .qr-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .qr-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .completion-status {
            font-size: 1.2em;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 10px;
        }
        
        .user-info-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1.1em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .form-submit-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.3em;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .form-submit-btn:hover {
            background: #2980b9;
        }
        
        .user-info-display {
            background: #d5f4e6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            color: #2c3e50;
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.1em;
        }
        
        .status-success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .status-error {
            background: #fadbd8;
            color: #c0392b;
            border: 1px solid #e74c3c;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .vote-title, .result-title { font-size: 1.6em; }
            .option-text-display { font-size: 1.4em; }
            .submit-btn { font-size: 1.4em; padding: 20px; }
            .tab { padding: 15px 20px; font-size: 1.1em; min-width: 150px; }
            .topic-header { flex-direction: column; gap: 15px; }
            .topic-title { width: 100%; }
            .admin-header { flex-direction: column; gap: 20px; }
            .admin-actions { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>可编辑投票系统</h1>
            <p>管理员可编辑投票事项，员工可扫码投票</p>
            <div class="mode-switcher">
                <button class="mode-btn active" id="userModeBtn">用户投票界面</button>
                <button class="mode-btn" id="adminModeBtn">管理员后台</button>
            </div>
        </div>
        
        <!-- 管理员后台 -->
        <div class="admin-panel" id="adminPanel">
            <div class="admin-header">
                <h2 class="admin-title">投票事项管理</h2>
                <div class="admin-actions">
                    <button class="admin-btn" id="addTopicBtn">添加新事项</button>
                    <button class="admin-btn save" id="saveAllBtn">保存所有更改</button>
                    <button class="admin-btn export" id="exportResultsBtn">导出投票结果</button>
                </div>
            </div>
            
            <div id="adminStatusMessage"></div>
            
            <div class="topics-container" id="adminTopicsContainer">
                <!-- 管理员编辑的事项列表将在这里动态生成 -->
            </div>
            
            <div class="qr-section">
                <h3>生成投票二维码</h3>
                <p>将此二维码分享给员工，员工扫描后可直接进入投票界面</p>
                <div class="qr-code" id="adminQrCode">
                    <!-- 二维码将在这里生成 -->
                </div>
                <div class="qr-actions">
                    <button class="qr-btn" id="downloadQrBtn">下载二维码图片</button>
                    <button class="qr-btn" id="refreshQrBtn">刷新二维码</button>
                </div>
                <div id="voteUrl" style="font-size: 1.2em; color: #666; margin-top: 10px; word-break: break-all;">
                    <!-- 投票链接将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 用户投票界面 -->
        <div class="user-panel active" id="userPanel">
            <!-- 用户信息表单 -->
            <div class="user-info-form" id="userInfoForm">
                <h3 class="form-title">请填写个人信息</h3>
                <div class="form-group">
                    <label for="userUnit">单位/部门</label>
                    <input type="text" id="userUnit" placeholder="请输入您的单位或部门">
                </div>
                <div class="form-group">
                    <label for="userName">姓名</label>
                    <input type="text" id="userName" placeholder="请输入您的姓名">
                </div>
                <div class="form-group">
                    <label for="userPhone">联系电话</label>
                    <input type="tel" id="userPhone" placeholder="请输入您的联系电话">
                </div>
                <div class="form-actions">
                    <button class="form-submit-btn" id="submitUserInfo">开始投票</button>
                </div>
            </div>
            
            <!-- 用户信息显示 -->
            <div class="user-info-display" id="userInfoDisplay" style="display: none;">
                <!-- 用户信息将在这里显示 -->
            </div>
            
            <div class="tabs" id="voteTabs">
                <!-- 选项卡由JavaScript动态生成 -->
            </div>
            
            <div id="tabContents">
                <!-- 选项卡内容由JavaScript动态生成 -->
            </div>
            
            <div class="result-section" id="resultSection">
                <div class="result-title">投票结果统计</div>
                <div id="resultsContainer"></div>
                <div class="thank-you">感谢您完成所有投票！</div>
            </div>
        </div>
    </div>

    <script>
        // 默认投票事项数据
        let voteTopics = [
            {
                id: 'leader',
                title: '选班长',
                description: '请选择您认为适合担任班长的同学',
                options: [
                    { value: 'zhang', label: '张同学', count: 24 },
                    { value: 'zhu', label: '朱同学', count: 17 },
                    { value: 'zhou', label: '周同学', count: 9 }
                ]
            },
            {
                id: 'study',
                title: '选学习委员',
                description: '请选择您认为适合担任学习委员的同学',
                options: [
                    { value: 'li', label: '李同学', count: 18 },
                    { value: 'wang', label: '王同学', count: 22 },
                    { value: 'chen', label: '陈同学', count: 10 }
                ]
            }
        ];

        // 用户投票记录
        let userVotes = {};
        let isAdminMode = false;
        let currentUserInfo = null;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        // 初始化页面
        function initializePage() {
            console.log('初始化页面...');
            
            // 尝试从本地存储加载数据
            const savedTopics = localStorage.getItem('voteTopics');
            if (savedTopics) {
                try {
                    voteTopics = JSON.parse(savedTopics);
                    console.log('投票数据加载成功');
                } catch (e) {
                    console.error('投票数据加载失败:', e);
                }
            }
            
            // 检查是否已投票
            const savedVotes = localStorage.getItem('userVotes');
            if (savedVotes) {
                try {
                    userVotes = JSON.parse(savedVotes);
                    if (Object.keys(userVotes).length === voteTopics.length) {
                        showResults();
                    }
                } catch (e) {
                    console.error('投票记录加载错误:', e);
                }
            }
            
            // 检查是否已填写用户信息
            const savedUserInfo = localStorage.getItem('currentUserInfo');
            if (savedUserInfo) {
                try {
                    currentUserInfo = JSON.parse(savedUserInfo);
                    showUserInfo();
                    hideUserInfoForm();
                } catch (e) {
                    console.error('用户信息加载错误:', e);
                }
            }
            
            // 初始化界面
            initializeUserInterface();
            initializeAdminInterface();
            
            // 设置模式切换事件
            document.getElementById('userModeBtn').addEventListener('click', switchToUserMode);
            document.getElementById('adminModeBtn').addEventListener('click', switchToAdminMode);
            
            // 设置用户信息提交事件
            document.getElementById('submitUserInfo').addEventListener('click', submitUserInfo);
            
            // 设置管理员按钮事件
            document.getElementById('addTopicBtn').addEventListener('click', addNewTopic);
            document.getElementById('saveAllBtn').addEventListener('click', saveAllChanges);
            document.getElementById('exportResultsBtn').addEventListener('click', exportResults);
            
            // 设置二维码按钮事件
            document.getElementById('downloadQrBtn').addEventListener('click', downloadQRCode);
            document.getElementById('refreshQrBtn').addEventListener('click', generateQRCode);
            
            // 检查URL参数，如果是扫码进入则自动跳转到用户界面
            checkUrlParams();
            
            // 生成管理员后台的二维码
            generateQRCode();
            
            console.log('页面初始化完成');
        }
        
        // 检查URL参数
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            
            if (mode === 'user') {
                // 如果是通过扫码进入，自动切换到用户界面
                switchToUserMode();
                
                setTimeout(() => {
                    document.querySelector('.tabs').scrollIntoView({ behavior: 'smooth' });
                }, 500);
            }
        }
        
        // 切换到用户模式
        function switchToUserMode() {
            isAdminMode = false;
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('userPanel').classList.add('active');
            document.getElementById('userModeBtn').classList.add('active');
            document.getElementById('adminModeBtn').classList.remove('active');
            initializeUserInterface();
        }
        
        // 切换到管理员模式
        function switchToAdminMode() {
            isAdminMode = true;
            document.getElementById('userPanel').classList.remove('active');
            document.getElementById('adminPanel').classList.add('active');
            document.getElementById('adminModeBtn').classList.add('active');
            document.getElementById('userModeBtn').classList.remove('active');
            initializeAdminInterface();
        }
        
        // 初始化用户界面
        function initializeUserInterface() {
            // 如果用户已填写信息，显示投票界面
            if (currentUserInfo) {
                hideUserInfoForm();
                createTabs();
                createTabContents();
                updateCompletionStatus();
            } else {
                // 显示用户信息表单
                showUserInfoForm();
            }
        }
        
        // 初始化管理员界面
        function initializeAdminInterface() {
            renderAdminTopics();
        }
        
        // 提交用户信息
        function submitUserInfo() {
            const unit = document.getElementById('userUnit').value.trim();
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            
            if (!unit || !name || !phone) {
                alert('请填写完整的个人信息');
                return;
            }
            
            // 保存用户信息
            currentUserInfo = { unit, name, phone };
            localStorage.setItem('currentUserInfo', JSON.stringify(currentUserInfo));
            
            // 显示用户信息并隐藏表单
            showUserInfo();
            hideUserInfoForm();
            
            // 初始化投票界面
            createTabs();
            createTabContents();
            updateCompletionStatus();
        }
        
        // 显示用户信息
        function showUserInfo() {
            if (currentUserInfo) {
                const displayElement = document.getElementById('userInfoDisplay');
                displayElement.innerHTML = `
                    <strong>投票人信息：</strong> ${currentUserInfo.unit} - ${currentUserInfo.name} (${currentUserInfo.phone})
                `;
                displayElement.style.display = 'block';
            }
        }
        
        // 显示用户信息表单
        function showUserInfoForm() {
            document.getElementById('userInfoForm').style.display = 'block';
            document.getElementById('userInfoDisplay').style.display = 'none';
            document.getElementById('voteTabs').style.display = 'none';
            document.getElementById('tabContents').style.display = 'none';
        }
        
        // 隐藏用户信息表单
        function hideUserInfoForm() {
            document.getElementById('userInfoForm').style.display = 'none';
            document.getElementById('voteTabs').style.display = 'flex';
            document.getElementById('tabContents').style.display = 'block';
        }
        
        // 创建选项卡
        function createTabs() {
            const tabsContainer = document.getElementById('voteTabs');
            tabsContainer.innerHTML = '';
            
            voteTopics.forEach((topic, index) => {
                const tab = document.createElement('div');
                tab.className = `tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = topic.title;
                tab.setAttribute('data-topic', topic.id);
                
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active类到当前选项卡和内容
                    tab.classList.add('active');
                    document.getElementById(`tab-${topic.id}`).classList.add('active');
                });
                
                tabsContainer.appendChild(tab);
            });
        }
        
        // 创建选项卡内容
        function createTabContents() {
            const contentsContainer = document.getElementById('tabContents');
            contentsContainer.innerHTML = '';
            
            voteTopics.forEach((topic, index) => {
                const content = document.createElement('div');
                content.className = `tab-content ${index === 0 ? 'active' : ''}`;
                content.id = `tab-${topic.id}`;
                
                // 检查是否已投票
                const hasVoted = userVotes.hasOwnProperty(topic.id);
                
                if (hasVoted) {
                    // 显示投票结果
                    content.innerHTML = `
                        <div class="vote-title">${topic.title}</div>
                        <div class="vote-description">${topic.description}</div>
                        <div class="result-item">
                            <div class="result-label">
                                <span>您已投票：${getVotedOptionText(topic.id)}</span>
                            </div>
                        </div>
                    `;
                } else {
                    // 构建选项HTML
                    const optionsHTML = topic.options.map(option => `
                        <div class="vote-option" data-value="${option.value}" data-topic="${topic.id}">
                            <div class="option-text-display">${option.label}</div>
                        </div>
                    `).join('');
                    
                    content.innerHTML = `
                        <div class="vote-title">${topic.title}</div>
                        <div class="vote-description">${topic.description}</div>
                        <div class="vote-options-container">
                            ${optionsHTML}
                        </div>
                        <div class="submit-section">
                            <button class="submit-btn" data-topic="${topic.id}">提交本事项投票</button>
                        </div>
                    `;
                }
                
                contentsContainer.appendChild(content);
            });
            
            // 添加选项点击事件
            document.querySelectorAll('.vote-option').forEach(option => {
                option.addEventListener('click', function() {
                    const topicId = this.getAttribute('data-topic');
                    const value = this.getAttribute('data-value');
                    
                    // 移除同一主题下其他选项的选中状态
                    document.querySelectorAll(`.vote-option[data-topic="${topicId}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // 设置当前选项为选中
                    this.classList.add('selected');
                    
                    // 启用提交按钮
                    document.querySelector(`.submit-btn[data-topic="${topicId}"]`).disabled = false;
                });
            });
            
            // 添加提交按钮事件
            document.querySelectorAll('.submit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const topicId = this.getAttribute('data-topic');
                    const selectedOption = document.querySelector(`.vote-option.selected[data-topic="${topicId}"]`);
                    
                    if (selectedOption) {
                        const value = selectedOption.getAttribute('data-value');
                        submitVote(topicId, value);
                    }
                });
                
                // 初始禁用提交按钮
                btn.disabled = true;
            });
        }
        
        // 获取已投票选项的文本
        function getVotedOptionText(topicId) {
            const votedOptionId = userVotes[topicId];
            const topic = voteTopics.find(t => t.id === topicId);
            if (topic) {
                const option = topic.options.find(o => o.value === votedOptionId);
                return option ? option.label : '未知选项';
            }
            return '未知选项';
        }
        
        // 提交单个事项的投票
        function submitVote(topicId, value) {
            userVotes[topicId] = value;
            localStorage.setItem('userVotes', JSON.stringify(userVotes));
            
            // 更新完成状态
            updateCompletionStatus();
            
            // 如果所有事项都已完成投票，显示结果
            if (Object.keys(userVotes).length === voteTopics.length) {
                showResults();
            } else {
                // 提示用户继续下一个事项
                alert(`您已完成"${getTopicTitle(topicId)}"的投票，请继续完成其他事项的投票。`);
                
                // 自动切换到下一个未投票的事项
                const nextTopic = voteTopics.find(topic => !userVotes[topic.id]);
                if (nextTopic) {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    document.querySelector(`.tab[data-topic="${nextTopic.id}"]`).classList.add('active');
                    document.getElementById(`tab-${nextTopic.id}`).classList.add('active');
                }
            }
        }
        
        // 获取事项标题
        function getTopicTitle(topicId) {
            const topic = voteTopics.find(t => t.id === topicId);
            return topic ? topic.title : '';
        }
        
        // 更新完成状态显示
        function updateCompletionStatus() {
            const completedCount = Object.keys(userVotes).length;
            const totalCount = voteTopics.length;
            
            // 创建或更新完成状态显示
            let statusElement = document.querySelector('.completion-status');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.className = 'completion-status';
                document.querySelector('.header').appendChild(statusElement);
            }
            
            statusElement.textContent = `完成进度: ${completedCount}/${totalCount} 个事项`;
            
            // 为已完成的选项卡添加标记
            voteTopics.forEach(topic => {
                const tab = document.querySelector(`.tab[data-topic="${topic.id}"]`);
                if (userVotes[topic.id]) {
                    tab.style.background = '#27ae60';
                } else {
                    tab.style.background = '';
                }
            });
        }
        
        // 显示投票结果
        function showResults() {
            document.querySelector('.tabs').style.display = 'none';
            document.getElementById('tabContents').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            let totalAllVotes = 0;
            
            // 计算并显示每个事项的结果
            voteTopics.forEach(topic => {
                const totalVotes = topic.options.reduce((sum, option) => sum + option.count, 0);
                totalAllVotes += totalVotes;
                
                const topicResult = document.createElement('div');
                topicResult.innerHTML = `<h3 style="font-size: 1.8em; color: #2c3e50; margin: 30px 0 15px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">${topic.title}</h3>`;
                
                topic.options.forEach(option => {
                    const percentage = totalVotes > 0 ? Math.round((option.count / totalVotes) * 100) : 0;
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    resultItem.innerHTML = `
                        <div class="result-label">
                            <span>${option.label}</span>
                            <span>${option.count} 票 (${percentage}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    `;
                    topicResult.appendChild(resultItem);
                });
                
                // 显示该事项总票数
                const totalElement = document.createElement('div');
                totalElement.style.cssText = 'text-align: center; font-size: 1.3em; color: #2c3e50; margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 10px;';
                totalElement.textContent = `本事项总投票数: ${totalVotes} 票`;
                topicResult.appendChild(totalElement);
                
                resultsContainer.appendChild(topicResult);
            });
            
            // 显示总票数
            const grandTotalElement = document.createElement('div');
            grandTotalElement.style.cssText = 'text-align: center; font-size: 1.5em; color: #2c3e50; margin-top: 30px; padding: 15px; background: #ecf0f1; border-radius: 10px;';
            grandTotalElement.textContent = `所有事项总投票数: ${totalAllVotes} 票`;
            resultsContainer.appendChild(grandTotalElement);
        }
        
        // 管理员界面功能
        function renderAdminTopics() {
            const container = document.getElementById('adminTopicsContainer');
            container.innerHTML = '';
            
            if (voteTopics.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d; font-size: 1.2em;">暂无投票事项，请点击"添加新事项"按钮创建</div>';
                return;
            }
            
            voteTopics.forEach((topic, index) => {
                const topicCard = document.createElement('div');
                topicCard.className = 'topic-card';
                topicCard.innerHTML = `
                    <div class="topic-header">
                        <input type="text" class="topic-title" value="${topic.title}" data-index="${index}">
                        <div class="topic-actions">
                            <button class="topic-btn edit" data-index="${index}">编辑</button>
                            <button class="topic-btn delete" data-index="${index}">删除</button>
                        </div>
                    </div>
                    <textarea class="topic-description" data-index="${index}">${topic.description}</textarea>
                    <div class="options-container" id="options-${topic.id}">
                        ${topic.options.map((option, optIndex) => `
                            <div class="option-item">
                                <input type="text" class="option-text" value="${option.label}" data-topic="${topic.id}" data-option="${optIndex}">
                                <div class="option-actions">
                                    <button class="option-btn delete" data-topic="${topic.id}" data-option="${optIndex}">删除</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-option">
                        <input type="text" class="new-option-input" placeholder="输入新选项内容" data-topic="${topic.id}">
                        <button class="add-option-btn" data-topic="${topic.id}">添加选项</button>
                    </div>
                `;
                
                container.appendChild(topicCard);
            });
            
            // 添加事件监听器
            document.querySelectorAll('.topic-title').forEach(input => {
                input.addEventListener('input', function() {
                    const index = this.getAttribute('data-index');
                    voteTopics[index].title = this.value;
                });
            });
            
            document.querySelectorAll('.topic-description').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const index = this.getAttribute('data-index');
                    voteTopics[index].description = this.value;
                });
            });
            
            document.querySelectorAll('.topic-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    editTopic(index);
                });
            });
            
            document.querySelectorAll('.topic-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    deleteTopic(index);
                });
            });
            
            document.querySelectorAll('.option-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const topicId = this.getAttribute('data-topic');
                    const optionIndex = this.getAttribute('data-option');
                    deleteOption(topicId, optionIndex);
                });
            });
            
            document.querySelectorAll('.option-text').forEach(input => {
                input.addEventListener('input', function() {
                    const topicId = this.getAttribute('data-topic');
                    const optionIndex = this.getAttribute('data-option');
                    const topic = voteTopics.find(t => t.id === topicId);
                    
                    if (topic && topic.options[optionIndex]) {
                        topic.options[optionIndex].label = this.value;
                    }
                });
            });
            
            document.querySelectorAll('.add-option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const topicId = this.getAttribute('data-topic');
                    const input = document.querySelector(`.new-option-input[data-topic="${topicId}"]`);
                    addOption(topicId, input.value);
                    input.value = '';
                });
            });
        }
        
        // 添加新投票事项
        function addNewTopic() {
            const newTopic = {
                id: 'topic-' + Date.now(),
                title: '新投票事项',
                description: '请描述这个投票事项',
                options: [
                    { value: 'option1', label: '选项1', count: 0 },
                    { value: 'option2', label: '选项2', count: 0 }
                ]
            };
            
            voteTopics.push(newTopic);
            renderAdminTopics();
            showStatusMessage('新投票事项已添加', 'success');
        }
        
        // 编辑投票事项
        function editTopic(index) {
            const topic = voteTopics[index];
            const newTitle = prompt('请输入事项标题:', topic.title);
            if (newTitle !== null) {
                topic.title = newTitle;
                
                const newDescription = prompt('请输入事项描述:', topic.description);
                if (newDescription !== null) {
                    topic.description = newDescription;
                    renderAdminTopics();
                }
            }
        }
        
        // 删除投票事项
        function deleteTopic(index) {
            if (confirm('确定要删除这个投票事项吗？此操作不可撤销。')) {
                voteTopics.splice(index, 1);
                renderAdminTopics();
                showStatusMessage('投票事项已删除', 'success');
            }
        }
        
        // 删除选项
        function deleteOption(topicId, optionIndex) {
            const topic = voteTopics.find(t => t.id === topicId);
            if (topic && topic.options.length > 1) {
                topic.options.splice(optionIndex, 1);
                renderAdminTopics();
                showStatusMessage('选项已删除', 'success');
            } else {
                alert('每个投票事项至少需要保留一个选项。');
            }
        }
        
        // 添加选项
        function addOption(topicId, optionText) {
            if (!optionText.trim()) {
                alert('请输入选项内容');
                return;
            }
            
            const topic = voteTopics.find(t => t.id === topicId);
            if (topic) {
                topic.options.push({
                    value: 'option-' + Date.now(),
                    label: optionText,
                    count: 0
                });
                renderAdminTopics();
                showStatusMessage('选项已添加', 'success');
            }
        }
        
        // 保存所有更改
        function saveAllChanges() {
            // 更新选项文本
            document.querySelectorAll('.option-text').forEach(input => {
                const topicId = input.getAttribute('data-topic');
                const optionIndex = input.getAttribute('data-option');
                const topic = voteTopics.find(t => t.id === topicId);
                
                if (topic && topic.options[optionIndex]) {
                    topic.options[optionIndex].label = input.value;
                }
            });
            
            // 保存到本地存储
            localStorage.setItem('voteTopics', JSON.stringify(voteTopics));
            showStatusMessage('所有更改已保存！', 'success');
            
            // 如果当前是用户模式，刷新用户界面
            if (!isAdminMode) {
                initializeUserInterface();
            }
        }
        
        // 导出结果
        function exportResults() {
            alert('导出功能将在实际部署后实现');
        }
        
        // 生成二维码
        function generateQRCode() {
            const qrElement = document.getElementById('adminQrCode');
            qrElement.innerHTML = '';
            
            try {
                // 生成用户投票链接（带参数，自动跳转到用户界面）
                const currentUrl = window.location.href.split('?')[0]; // 移除现有参数
                const voteUrl = `${currentUrl}?mode=user`;
                
                // 使用QRCode生成二维码
                QRCode.toCanvas(qrElement, voteUrl, {
                    width: 180,
                    height: 180,
                    margin: 1,
                    color: {
                        dark: '#2c3e50',
                        light: '#ffffff'
                    }
                }, function(error) {
                    if (error) {
                        console.error('生成二维码时出错:', error);
                        qrElement.innerHTML = '二维码生成失败<br>请刷新页面重试';
                        showStatusMessage('二维码生成失败，请检查网络连接或刷新页面', 'error');
                    } else {
                        console.log('二维码生成成功');
                        showStatusMessage('二维码已生成，可下载分享给员工', 'success');
                    }
                });
                
                // 更新投票链接显示
                const voteUrlElement = document.getElementById('voteUrl');
                voteUrlElement.innerHTML = `投票链接: <a href="${voteUrl}" target="_blank">${voteUrl}</a>`;
            } catch (error) {
                console.error('生成二维码时发生异常:', error);
                qrElement.innerHTML = '二维码生成失败<br>请检查QRCode库是否加载';
                showStatusMessage('二维码生成失败，请检查QRCode库是否加载', 'error');
            }
        }
        
        // 下载二维码图片
        function downloadQRCode() {
            const canvas = document.querySelector('#adminQrCode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = '投票二维码.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                showStatusMessage('二维码图片已下载', 'success');
            } else {
                alert('二维码尚未生成，请先生成二维码再下载。');
                showStatusMessage('二维码尚未生成，请先生成二维码', 'error');
            }
        }
        
        // 显示状态消息
        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('adminStatusMessage');
            statusElement.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusElement.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>
